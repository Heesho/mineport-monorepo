# =============================================================================
# MINEPORT UNIFIED SUBGRAPH SCHEMA
# =============================================================================
# Central concept: Unit token is the universal entity across all rig types
# Each Unit has an LP pair (Unit/DONUT) for price tracking
# Rigs are specialized by type but linked to their Unit
# =============================================================================

# =============================================================================
# GLOBAL PROTOCOL STATS
# =============================================================================

type Protocol @entity(immutable: false) {
  id: ID!                              # "mineport"

  # Counts
  totalUnits: BigInt!                  # Total Unit tokens launched
  totalRigs: BigInt!                   # Total rigs (same as units)

  # Volume (in DONUT)
  totalVolumeDonut: BigDecimal!        # All-time trading volume
  totalVolume24h: BigDecimal!          # Rolling 24h volume (updated hourly)

  # Liquidity
  totalLiquidityDonut: BigDecimal!     # Current total liquidity in DONUT

  # Revenue
  totalTreasuryRevenue: BigDecimal!    # All treasury fees collected
  totalProtocolRevenue: BigDecimal!    # Protocol fees (1%)

  # Emissions
  totalMinted: BigDecimal!             # All Unit tokens minted across all rigs

  # Timestamps
  lastUpdated: BigInt!
}

# =============================================================================
# UNIT TOKEN - The Universal Entity (Explore Page)
# =============================================================================

type Unit @entity(immutable: false) {
  id: ID!                              # Unit token address

  # Basic info
  name: String!
  symbol: String!
  decimals: Int!

  # Supply
  totalSupply: BigDecimal!             # Current total supply
  totalMinted: BigDecimal!             # Total ever minted by rig

  # Associated contracts
  lpPair: Bytes!                       # LP pair address (Unit/DONUT)
  donutToken: Bytes!                   # DONUT address (constant)
  launcher: Account!

  # ==========================================================================
  # PRICE DATA (from LP Sync events)
  # ==========================================================================

  # Current price
  price: BigDecimal!                   # Current price in DONUT (reserve_donut / reserve_unit)
  priceUSD: BigDecimal!                # Price in USD (if DONUT price available)

  # Market metrics
  marketCap: BigDecimal!               # price * totalSupply (in DONUT)
  marketCapUSD: BigDecimal!            # Market cap in USD
  liquidity: BigDecimal!               # Total DONUT in LP
  liquidityUSD: BigDecimal!            # Liquidity in USD

  # LP reserves (from Sync)
  reserveUnit: BigDecimal!             # Unit tokens in LP
  reserveDonut: BigDecimal!            # DONUT in LP

  # ==========================================================================
  # VOLUME DATA (from LP Swap events)
  # ==========================================================================

  volume24h: BigDecimal!               # 24h volume in DONUT
  volume7d: BigDecimal!                # 7d volume in DONUT
  volumeTotal: BigDecimal!             # All-time volume in DONUT
  txCount: BigInt!                     # Total swap transactions
  txCount24h: BigInt!                  # 24h transaction count

  # ==========================================================================
  # PRICE CHANGE
  # ==========================================================================

  priceChange1h: BigDecimal!           # % change
  priceChange24h: BigDecimal!          # % change
  priceChange7d: BigDecimal!           # % change

  priceHigh24h: BigDecimal!            # 24h high
  priceLow24h: BigDecimal!             # 24h low

  # For calculating 24h change
  price1hAgo: BigDecimal!              # Price snapshot
  price24hAgo: BigDecimal!             # Price snapshot
  price7dAgo: BigDecimal!              # Price snapshot

  # ==========================================================================
  # ACTIVITY (for "bump" sorting)
  # ==========================================================================

  lastSwapAt: BigInt!                  # Last LP swap timestamp
  lastRigActivityAt: BigInt!           # Last rig event (mine, spin, etc)
  lastActivityAt: BigInt!              # Max of swap and rig activity

  # ==========================================================================
  # HOLDER DATA (optional - from Transfer events)
  # ==========================================================================

  holderCount: BigInt!                 # Unique holders

  # ==========================================================================
  # TIMESTAMPS
  # ==========================================================================

  createdAt: BigInt!
  createdAtBlock: BigInt!

  # ==========================================================================
  # RELATIONS
  # ==========================================================================

  rig: Rig!                            # The rig that mints this token
  swaps: [Swap!]! @derivedFrom(field: "unit")
  hourData: [UnitHourData!]! @derivedFrom(field: "unit")
  dayData: [UnitDayData!]! @derivedFrom(field: "unit")
}

# =============================================================================
# PRICE CHART DATA
# =============================================================================

# Hourly OHLCV candles
type UnitHourData @entity(immutable: false) {
  id: ID!                              # {unitAddress}-{hourTimestamp}
  unit: Unit!

  # Time
  timestamp: BigInt!                   # Hour start (unix)
  hourIndex: Int!                      # Hours since epoch

  # OHLC (in DONUT)
  open: BigDecimal!
  high: BigDecimal!
  low: BigDecimal!
  close: BigDecimal!

  # Volume
  volumeUnit: BigDecimal!              # Unit volume this hour
  volumeDonut: BigDecimal!             # DONUT volume this hour
  txCount: BigInt!                     # Swaps this hour

  # Liquidity snapshot
  liquidity: BigDecimal!               # DONUT in LP at hour end
}

# Daily OHLCV candles
type UnitDayData @entity(immutable: false) {
  id: ID!                              # {unitAddress}-{dayTimestamp}
  unit: Unit!

  # Time
  timestamp: BigInt!                   # Day start (unix)
  dayIndex: Int!                       # Days since epoch

  # OHLC (in DONUT)
  open: BigDecimal!
  high: BigDecimal!
  low: BigDecimal!
  close: BigDecimal!

  # Volume
  volumeUnit: BigDecimal!
  volumeDonut: BigDecimal!
  txCount: BigInt!

  # Liquidity snapshot
  liquidity: BigDecimal!

  # Supply snapshot
  totalSupply: BigDecimal!
  totalMinted: BigDecimal!
}

# =============================================================================
# SWAP EVENTS (Buy/Sell activity)
# =============================================================================

type Swap @entity(immutable: true) {
  id: ID!                              # {txHash}-{logIndex}
  unit: Unit!
  account: Account!

  # Swap details
  type: String!                        # "buy" or "sell"
  amountUnit: BigDecimal!              # Unit tokens swapped
  amountDonut: BigDecimal!             # DONUT swapped
  price: BigDecimal!                   # Execution price (donut/unit)

  # Transaction
  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
  logIndex: BigInt!
}

# =============================================================================
# RIG - General Entity (links to specialized types)
# =============================================================================

type Rig @entity(immutable: false) {
  id: ID!                              # Rig contract address
  unit: Unit!                          # The Unit token this rig mints
  rigType: String!                     # "seat", "spin", "charity"

  # Common fields
  launcher: Account!
  auction: Bytes!
  quoteToken: Bytes!                   # Payment token for rig actions
  uri: String!

  # Revenue tracking (in quoteToken)
  treasuryRevenue: BigDecimal!         # Fees sent to auction/treasury
  teamRevenue: BigDecimal!             # Fees to team
  protocolRevenue: BigDecimal!         # Fees to protocol

  # Emission tracking
  totalMinted: BigDecimal!             # Total Unit tokens minted by this rig

  # Activity
  lastActivityAt: BigInt!              # Last rig-specific event

  # Timestamps
  createdAt: BigInt!
  createdAtBlock: BigInt!

  # ==========================================================================
  # Specialized data (ONE of these will be set based on rigType)
  # ==========================================================================

  mineRig: MineRig
  slotRig: SlotRig
  fundRig: FundRig
}

# =============================================================================
# SEAT RIG - Mining seat competition
# =============================================================================

type MineRig @entity(immutable: false) {
  id: ID!                              # Same as Rig id
  rig: Rig!

  # Emission config
  initialUps: BigInt!                  # Starting units per second
  tailUps: BigInt!                     # Minimum units per second (floor)
  halvingAmount: BigInt!               # Token supply threshold for halving

  # Rig config
  capacity: BigInt!                    # Number of slots
  epochPeriod: BigInt!                 # Dutch auction epoch duration
  priceMultiplier: BigDecimal!         # Price multiplier after sale
  minInitPrice: BigDecimal!            # Minimum starting price

  # State
  activeMiners: BigInt!                # Current occupied slots
  totalMines: BigInt!                  # All-time mine count

  # Relations
  slots: [SeatSlot!]! @derivedFrom(field: "mineRig")
  mines: [SeatMine!]! @derivedFrom(field: "mineRig")
}

type SeatSlot @entity(immutable: false) {
  id: ID!                              # {rigAddress}-{slotIndex}
  mineRig: MineRig!
  index: BigInt!

  # Current state
  epochId: BigInt!
  currentMiner: Account
  uri: String!
  initPrice: BigDecimal!               # Current epoch starting price
  startTime: BigInt!                   # Current epoch start

  # Stats
  minted: BigDecimal!                  # Total minted on this slot
  lastMined: BigInt!
}

type SeatMine @entity(immutable: true) {
  id: ID!                              # {txHash}-{logIndex}
  mineRig: MineRig!
  slot: SeatSlot!

  miner: Account!
  prevMiner: Account

  slotIndex: BigInt!
  epochId: BigInt!
  uri: String!

  price: BigDecimal!                   # What miner paid
  minted: BigDecimal!                  # Tokens minted to prev miner
  earned: BigDecimal!                  # Fee earned by prev miner

  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

# =============================================================================
# SPIN RIG - Slot machine with VRF
# =============================================================================

type SlotRig @entity(immutable: false) {
  id: ID!
  rig: Rig!

  # Emission config
  initialUps: BigInt!                  # Starting units per second
  tailUps: BigInt!                     # Minimum units per second (floor)
  halvingPeriod: BigInt!               # Time between halvings (seconds)

  # Rig config (immutable)
  epochPeriod: BigInt!                 # Duration of each price decay epoch
  priceMultiplier: BigDecimal!         # Price multiplier after each spin
  minInitPrice: BigDecimal!            # Minimum starting price

  # Dutch Auction State
  currentEpochId: BigInt!              # Current epoch ID
  initPrice: BigDecimal!               # Current epoch's starting price
  slotStartTime: BigInt!               # When current epoch started

  # Prize Pool
  prizePool: BigDecimal!               # Current prize pool (Unit tokens from emissions)
  currentOdds: [BigInt!]!              # Current odds array (basis points for payout %)

  # Stats
  totalSpins: BigInt!
  totalWins: BigInt!
  totalWonAmount: BigDecimal!          # Total Unit won from prize pool
  totalSpent: BigDecimal!              # Total quoteToken spent on spins

  # Relations
  spins: [Spin!]! @derivedFrom(field: "slotRig")
}

type Spin @entity(immutable: true) {
  id: ID!                              # {txHash}-{logIndex}
  slotRig: SlotRig!
  spinner: Account!

  epochId: BigInt!
  price: BigDecimal!                   # Spin cost

  # Result (filled after VRF callback)
  won: Boolean!
  winAmount: BigDecimal!               # Amount won (0 if lost)
  oddsBps: BigInt!                     # Odds that were hit

  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

# =============================================================================
# CHARITY RIG - Daily donation pool mining
# =============================================================================

type FundRig @entity(immutable: false) {
  id: ID!
  rig: Rig!

  # Emission config
  initialEmission: BigInt!             # Starting daily emission
  minEmission: BigInt!                 # Minimum daily emission (floor)
  minDonation: BigInt!                 # Minimum donation amount

  # State
  currentDay: BigInt!                  # Current day number

  # Stats
  totalDonated: BigDecimal!            # Total donations received
  totalMinted: BigDecimal!             # Total Unit tokens minted to donors
  uniqueDonors: BigInt!                # Unique donor count

  # Relations
  donations: [Donation!]! @derivedFrom(field: "fundRig")
  recipients: [CharityRecipient!]! @derivedFrom(field: "fundRig")
  dayData: [CharityDayData!]! @derivedFrom(field: "fundRig")
}

# Whitelisted recipient for FundRig
type CharityRecipient @entity(immutable: false) {
  id: ID!                              # {rigAddress}-{recipientAddress}
  fundRig: FundRig!
  recipient: Bytes!                    # Recipient address
  isActive: Boolean!                   # Whether currently whitelisted
  totalReceived: BigDecimal!           # Total donations received
  addedAt: BigInt!
}

# Daily donation pool data
type CharityDayData @entity(immutable: false) {
  id: ID!                              # {rigAddress}-{day}
  fundRig: FundRig!
  day: BigInt!                         # Day number (days since rig start)

  totalDonated: BigDecimal!            # Total donated this day
  donorCount: BigInt!                  # Number of unique donors this day
  emission: BigDecimal!                # Unit emission for this day

  # Timestamps
  timestamp: BigInt!                   # Day start timestamp
}

type Donation @entity(immutable: true) {
  id: ID!                              # {txHash}-{logIndex}
  fundRig: FundRig!

  donor: Account!
  recipient: Bytes!                    # Which whitelisted recipient received funds

  day: BigInt!                         # Day number
  amount: BigDecimal!                  # Donation amount

  # Fee split (calculated from amount)
  recipientAmount: BigDecimal!         # 50% to recipient
  treasuryAmount: BigDecimal!          # 45% to treasury
  teamAmount: BigDecimal!              # 4% to team

  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

# Claim record (when donor claims their Unit tokens)
type CharityClaim @entity(immutable: true) {
  id: ID!                              # {txHash}-{logIndex}
  fundRig: FundRig!

  claimer: Account!
  day: BigInt!                         # Day being claimed
  amount: BigDecimal!                  # Unit tokens minted

  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

# =============================================================================
# ACCOUNT - User wallet
# =============================================================================

type Account @entity(immutable: false) {
  id: ID!                              # Wallet address

  # Aggregate stats
  totalSwapVolume: BigDecimal!         # Volume traded in DONUT
  totalRigSpend: BigDecimal!           # Spent on rig actions
  totalMined: BigDecimal!              # Unit tokens earned
  totalWon: BigDecimal!                # Unit tokens won (spin)

  # Activity
  lastActivityAt: BigInt!

  # Relations
  unitsLaunched: [Unit!]! @derivedFrom(field: "launcher")
  swaps: [Swap!]! @derivedFrom(field: "account")
  seatMines: [SeatMine!]! @derivedFrom(field: "miner")
  seatSlots: [SeatSlot!]! @derivedFrom(field: "currentMiner")
  spins: [Spin!]! @derivedFrom(field: "spinner")
  donations: [Donation!]! @derivedFrom(field: "donor")
}

# =============================================================================
# DONUT TOKEN (for USD conversion - optional)
# =============================================================================

type DonutToken @entity(immutable: false) {
  id: ID!                              # "donut" or donut address
  priceUSD: BigDecimal!                # Current DONUT/USD price
  lastUpdated: BigInt!
}
